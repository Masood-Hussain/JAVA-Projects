<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Food Delivery Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .order-card {
            transition: transform 0.3s;
            border-radius: 10px;
        }
        .order-card:hover {
            transform: translateY(-3px);
        }
        .status-pending { border-left: 4px solid #ffc107; }
        .status-confirmed { border-left: 4px solid #17a2b8; }
        .status-preparing { border-left: 4px solid #fd7e14; }
        .status-ready { border-left: 4px solid #6f42c1; }
        .status-delivered { border-left: 4px solid #28a745; }
        .status-cancelled { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-arrow-left"></i> Admin Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">Dashboard</a>
                <a class="nav-link" href="/admin/restaurants">Restaurants</a>
                <a class="nav-link active" href="/admin/orders">Orders</a>
                <a class="nav-link" href="/admin/deliveries">Deliveries</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2><i class="bi bi-bag-check"></i> Order Management</h2>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="filterOrders('all')">All</button>
                    <button type="button" class="btn btn-outline-warning" onclick="filterOrders('pending')">Pending</button>
                    <button type="button" class="btn btn-outline-info" onclick="filterOrders('preparing')">Preparing</button>
                    <button type="button" class="btn btn-outline-success" onclick="filterOrders('delivered')">Delivered</button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Pending</h5>
                        <h3 class="mb-0" id="pending-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title text-info">In Progress</h5>
                        <h3 class="mb-0" id="progress-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="card-title text-success">Delivered</h5>
                        <h3 class="mb-0" id="delivered-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Total Revenue</h5>
                        <h3 class="mb-0" id="total-revenue">₹0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search orders..." id="search-input">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="restaurant-filter">
                    <option value="">All Restaurants</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="date-filter">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="refreshOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Orders List -->
        <div class="row" id="orders-container">
            <div class="col-12" th:if="${#lists.isEmpty(orders)}">
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle"></i> No orders found.
                </div>
            </div>

            <div class="col-md-6 col-lg-4 mb-3" th:each="order : ${orders}">
                <div class="card order-card h-100" th:classappend="'status-' + ${order.status?.toString()?.toLowerCase()}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Order #<span th:text="${order.id}">123</span></h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" th:onclick="'viewOrder(' + ${order.id} + ')'">
                                    <i class="bi bi-eye"></i> View Details
                                </a></li>
                                <li><a class="dropdown-item" href="#" th:onclick="'updateStatus(' + ${order.id} + ')'">
                                    <i class="bi bi-arrow-repeat"></i> Update Status
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                    <i class="bi bi-x-circle"></i> Cancel Order
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Customer:</strong> <span th:text="${order.customerName ?: 'N/A'}">Customer Name</span>
                        </div>
                        <div class="mb-2">
                            <strong>Restaurant:</strong> <span th:text="${order.restaurantName ?: 'N/A'}">Restaurant</span>
                        </div>
                        <div class="mb-2">
                            <strong>Total:</strong> <span class="text-success fw-bold">₹<span th:text="${order.totalAmount ?: 0}">0</span></span>
                        </div>
                        <div class="mb-2">
                            <strong>Status:</strong>
                            <span class="badge" th:classappend="'bg-' + ${order.status?.toString()?.toLowerCase() == 'pending' ? 'warning' : (order.status?.toString()?.toLowerCase() == 'delivered' ? 'success' : 'info')}"
                                  th:text="${order.status ?: 'PENDING'}">Status</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> 
                                <span th:text="${order.createdAt ?: #temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">Just now</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="order-details-content">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printOrder()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="status-update-form">
                        <input type="hidden" id="update-order-id">
                        <div class="mb-3">
                            <label class="form-label">New Status</label>
                            <select class="form-select" id="new-status" required>
                                <option value="PENDING">Pending</option>
                                <option value="CONFIRMED">Confirmed</option>
                                <option value="PREPARING">Preparing</option>
                                <option value="READY">Ready for Delivery</option>
                                <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
                                <option value="DELIVERED">Delivered</option>
                                <option value="CANCELLED">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="status-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadRestaurants();
            setupEventListeners();
        });

        function loadOrders() {
            // This would normally fetch from API
            // For demo, using sample data
            allOrders = [
                {
                    id: 1,
                    customerName: 'John Doe',
                    restaurantName: 'Pizza Palace',
                    totalAmount: 450,
                    status: 'PENDING',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    customerName: 'Jane Smith',
                    restaurantName: 'Burger House',
                    totalAmount: 320,
                    status: 'DELIVERED',
                    createdAt: new Date(Date.now() - 3600000).toISOString()
                }
            ];
            
            filteredOrders = [...allOrders];
            updateOrderCounts();
        }

        function loadRestaurants() {
            fetch('/admin/api/restaurants')
                .then(response => response.json())
                .then(restaurants => {
                    const select = document.getElementById('restaurant-filter');
                    restaurants.forEach(restaurant => {
                        const option = document.createElement('option');
                        option.value = restaurant.id;
                        option.textContent = restaurant.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.log('Could not load restaurants'));
        }

        function updateOrderCounts() {
            const pending = allOrders.filter(o => o.status === 'PENDING' || o.status === 'CONFIRMED').length;
            const progress = allOrders.filter(o => o.status === 'PREPARING' || o.status === 'OUT_FOR_DELIVERY').length;
            const delivered = allOrders.filter(o => o.status === 'DELIVERED').length;
            const revenue = allOrders.filter(o => o.status === 'DELIVERED').reduce((sum, o) => sum + o.totalAmount, 0);

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('progress-count').textContent = progress;
            document.getElementById('delivered-count').textContent = delivered;
            document.getElementById('total-revenue').textContent = '₹' + revenue.toLocaleString();
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', filterOrdersDisplay);
            document.getElementById('restaurant-filter').addEventListener('change', filterOrdersDisplay);
            document.getElementById('date-filter').addEventListener('change', filterOrdersDisplay);
        }

        function filterOrders(status) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (status === 'all') {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => 
                    order.status.toLowerCase().includes(status.toLowerCase())
                );
            }
            
            filterOrdersDisplay();
        }

        function filterOrdersDisplay() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const restaurantFilter = document.getElementById('restaurant-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            let filtered = [...filteredOrders];
            
            if (searchTerm) {
                filtered = filtered.filter(order => 
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    order.restaurantName.toLowerCase().includes(searchTerm) ||
                    order.id.toString().includes(searchTerm)
                );
            }
            
            if (restaurantFilter) {
                filtered = filtered.filter(order => order.restaurantId == restaurantFilter);
            }
            
            if (dateFilter) {
                filtered = filtered.filter(order => 
                    new Date(order.createdAt).toDateString() === new Date(dateFilter).toDateString()
                );
            }
            
            displayOrders(filtered);
        }

        function displayOrders(orders) {
            // This would update the DOM with filtered orders
            console.log('Displaying orders:', orders);
        }

        function viewOrder(orderId) {
            // Load and display order details
            fetch(`/admin/api/orders/${orderId}`)
                .then(response => response.json())
                .then(order => {
                    const content = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Customer Information</h6>
                                <p><strong>Name:</strong> ${order.customerName || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                                <p><strong>Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Order Information</h6>
                                <p><strong>Order ID:</strong> #${order.id}</p>
                                <p><strong>Restaurant:</strong> ${order.restaurantName || 'N/A'}</p>
                                <p><strong>Status:</strong> ${order.status || 'PENDING'}</p>
                                <p><strong>Total:</strong> ₹${order.totalAmount || 0}</p>
                            </div>
                        </div>
                        <hr>
                        <h6>Order Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(order.items || []).map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>₹${item.price}</td>
                                            <td>₹${item.quantity * item.price}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('order-details-content').innerHTML = content;
                    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
                })
                .catch(error => {
                    alert('Could not load order details');
                });
        }

        function updateStatus(orderId) {
            document.getElementById('update-order-id').value = orderId;
            new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
        }

        function saveStatusUpdate() {
            const orderId = document.getElementById('update-order-id').value;
            const newStatus = document.getElementById('new-status').value;
            const notes = document.getElementById('status-notes').value;
            
            fetch(`/admin/api/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: newStatus,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(result => {
                bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
                refreshOrders();
                alert('Order status updated successfully!');
            })
            .catch(error => {
                alert('Failed to update order status');
            });
        }

        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                updateOrderStatus(orderId, 'CANCELLED');
            }
        }

        function updateOrderStatus(orderId, status) {
            fetch(`/admin/api/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(result => {
                refreshOrders();
                alert('Order status updated successfully!');
            })
            .catch(error => {
                alert('Failed to update order status');
            });
        }

        function refreshOrders() {
            location.reload();
        }

        function printOrder() {
            window.print();
        }
    </script>
</body>
</html>
