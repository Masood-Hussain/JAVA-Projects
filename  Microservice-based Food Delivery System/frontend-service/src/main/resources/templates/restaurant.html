<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${restaurant != null ? restaurant.name + ' - Food Delivery' : 'Restaurant - Food Delivery'}">Restaurant - Food Delivery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .food-item-card {
            transition: transform 0.2s ease-in-out;
        }
        .food-item-card:hover {
            transform: translateY(-5px);
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .cart-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
        }
        .cart-sidebar.open {
            right: 0;
        }
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1049;
            display: none;
        }
        .cart-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-shop"></i> Food Delivery</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <button class="btn btn-outline-primary position-relative" onclick="toggleCart()">
                    <i class="bi bi-cart3"></i> Cart
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Restaurant Header -->
        <div class="row mb-4" th:if="${restaurant}">
            <div class="col">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h1 class="card-title mb-2" th:text="${restaurant.name}">Restaurant Name</h1>
                                <p class="card-text mb-1">
                                    <i class="bi bi-tag"></i> <span th:text="${restaurant.cuisine}">Cuisine Type</span>
                                </p>
                                <p class="card-text mb-1">
                                    <i class="bi bi-geo-alt"></i> <span th:text="${restaurant.address}">Address</span>
                                </p>
                                <p class="card-text mb-0">
                                    <i class="bi bi-telephone"></i> <span th:text="${restaurant.phone}">Phone</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="badge bg-success fs-6 p-2">
                                    <i class="bi bi-clock"></i> Open Now
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="alert alert-danger" th:if="${error}">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}">Error message</span>
        </div>

        <!-- Menu Items -->
        <div class="row" th:if="${menuItems != null and !#lists.isEmpty(menuItems)}">
            <div class="col">
                <h3 class="mb-4"><i class="bi bi-list-ul"></i> Our Menu</h3>
                
                <!-- Category Filter -->
                <div class="mb-4">
                    <div class="btn-group flex-wrap" role="group">
                        <input type="radio" class="btn-check" name="categoryFilter" id="filterAll" value="ALL" checked>
                        <label class="btn btn-outline-primary" for="filterAll">All Items</label>
                        
                        <input type="radio" class="btn-check" name="categoryFilter" id="filterAppetizers" value="APPETIZERS">
                        <label class="btn btn-outline-primary" for="filterAppetizers">Appetizers</label>
                        
                        <input type="radio" class="btn-check" name="categoryFilter" id="filterMainCourse" value="MAIN_COURSE">
                        <label class="btn btn-outline-primary" for="filterMainCourse">Main Course</label>
                        
                        <input type="radio" class="btn-check" name="categoryFilter" id="filterDesserts" value="DESSERTS">
                        <label class="btn btn-outline-primary" for="filterDesserts">Desserts</label>
                        
                        <input type="radio" class="btn-check" name="categoryFilter" id="filterBeverages" value="BEVERAGES">
                        <label class="btn btn-outline-primary" for="filterBeverages">Beverages</label>
                    </div>
                </div>

                <!-- Menu Items Grid -->
                <div class="row" id="menuItemsContainer">
                    <div class="col-md-6 col-lg-4 mb-4 menu-item-card" 
                         th:each="item : ${menuItems}" 
                         th:data-category="${item.category}"
                         th:if="${item.available}">
                        <div class="card h-100 food-item-card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary" th:text="${item.category}">Category</span>
                                <span class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title" th:text="${item.name}">Item Name</h5>
                                <p class="card-text text-muted small" th:text="${item.description}" 
                                   th:if="${item.description}">Description</p>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="text-success mb-0">₹<span th:text="${item.price}">0.00</span></h4>
                                    <div class="quantity-control">
                                        <button class="btn btn-outline-secondary quantity-btn" 
                                                th:onclick="'decreaseQuantity(' + ${item.id} + ')'">-</button>
                                        <span class="mx-2 fw-bold quantity-display" th:id="'quantity-' + ${item.id}">0</span>
                                        <button class="btn btn-outline-secondary quantity-btn" 
                                                th:onclick="'increaseQuantity(' + ${item.id} + ', \'' + ${item.name} + '\', ' + ${item.price} + ')'">+</button>
                                    </div>
                                </div>
                                <button class="btn btn-primary w-100" 
                                        th:onclick="'addToCart(' + ${item.id} + ', \'' + ${item.name} + '\', ' + ${item.price} + ')'"
                                        th:id="'addBtn-' + ${item.id}">
                                    <i class="bi bi-cart-plus"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Menu Items -->
        <div class="row" th:if="${menuItems == null or #lists.isEmpty(menuItems)}">
            <div class="col text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-basket3" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">No Menu Items Available</h4>
                        <p class="text-muted">This restaurant hasn't added their menu yet. Please check back later!</p>
                        <a href="/" class="btn btn-primary">Browse Other Restaurants</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Overlay -->
    <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="bi bi-cart3"></i> Your Cart</h4>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleCart()">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <div id="cartItems"></div>

            <div class="border-top pt-3 mt-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Total: ₹<span id="cartTotal">0.00</span></h5>
                </div>
                
                <div class="mb-3">
                    <label for="customerName" class="form-label">Your Name *</label>
                    <input type="text" class="form-control" id="customerName" placeholder="Enter your name" required>
                </div>
                
                <div class="mb-3">
                    <label for="deliveryAddress" class="form-label">Delivery Address *</label>
                    <textarea class="form-control" id="deliveryAddress" rows="2" 
                              placeholder="Enter delivery address" required></textarea>
                </div>

                <button class="btn btn-success w-100" id="checkoutBtn" onclick="checkout()" disabled>
                    <i class="bi bi-credit-card"></i> Place Order
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = {};
        let cartCount = 0;
        let cartTotal = 0;
        const restaurantId = window.location.pathname.split('/')[2];

        document.addEventListener('DOMContentLoaded', function() {
            updateCartDisplay();
            
            // Category filter functionality
            document.querySelectorAll('input[name="categoryFilter"]').forEach(radio => {
                radio.addEventListener('change', filterByCategory);
            });

            // Enable checkout button when required fields are filled
            document.getElementById('customerName').addEventListener('input', checkCheckoutButton);
            document.getElementById('deliveryAddress').addEventListener('input', checkCheckoutButton);
        });

        function filterByCategory() {
            const selectedCategory = document.querySelector('input[name="categoryFilter"]:checked').value;
            const menuItems = document.querySelectorAll('.menu-item-card');
            
            menuItems.forEach(item => {
                if (selectedCategory === 'ALL' || item.dataset.category === selectedCategory) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function increaseQuantity(itemId, itemName, itemPrice) {
            const quantitySpan = document.getElementById('quantity-' + itemId);
            let currentQuantity = parseInt(quantitySpan.textContent);
            currentQuantity++;
            quantitySpan.textContent = currentQuantity;
            
            if (!cart[itemId]) {
                cart[itemId] = {
                    name: itemName,
                    price: itemPrice,
                    quantity: 0
                };
            }
            cart[itemId].quantity = currentQuantity;
            updateCartDisplay();
        }

        function decreaseQuantity(itemId) {
            const quantitySpan = document.getElementById('quantity-' + itemId);
            let currentQuantity = parseInt(quantitySpan.textContent);
            if (currentQuantity > 0) {
                currentQuantity--;
                quantitySpan.textContent = currentQuantity;
                
                if (cart[itemId]) {
                    cart[itemId].quantity = currentQuantity;
                    if (currentQuantity === 0) {
                        delete cart[itemId];
                    }
                }
                updateCartDisplay();
            }
        }

        function addToCart(itemId, itemName, itemPrice) {
            const quantitySpan = document.getElementById('quantity-' + itemId);
            let quantity = parseInt(quantitySpan.textContent);
            
            if (quantity === 0) {
                quantity = 1;
                quantitySpan.textContent = quantity;
            }
            
            if (!cart[itemId]) {
                cart[itemId] = {
                    name: itemName,
                    price: itemPrice,
                    quantity: 0
                };
            }
            cart[itemId].quantity = quantity;
            updateCartDisplay();
            toggleCart();
        }

        function removeFromCart(itemId) {
            delete cart[itemId];
            document.getElementById('quantity-' + itemId).textContent = '0';
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartCountSpan = document.getElementById('cartCount');
            const cartTotalSpan = document.getElementById('cartTotal');
            
            cartCount = 0;
            cartTotal = 0;
            cartItemsDiv.innerHTML = '';

            if (Object.keys(cart).length === 0) {
                cartItemsDiv.innerHTML = '<p class="text-muted text-center">Your cart is empty</p>';
            } else {
                for (let itemId in cart) {
                    const item = cart[itemId];
                    cartCount += item.quantity;
                    cartTotal += item.price * item.quantity;
                    
                    cartItemsDiv.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                            <div>
                                <h6 class="mb-1">${item.name}</h6>
                                <small class="text-muted">₹${item.price} × ${item.quantity}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2">₹${(item.price * item.quantity).toFixed(2)}</strong>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${itemId}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            cartCountSpan.textContent = cartCount;
            cartTotalSpan.textContent = cartTotal.toFixed(2);
            checkCheckoutButton();
        }

        function toggleCart() {
            const cartSidebar = document.getElementById('cartSidebar');
            const cartOverlay = document.getElementById('cartOverlay');
            
            cartSidebar.classList.toggle('open');
            cartOverlay.classList.toggle('show');
        }

        function checkCheckoutButton() {
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            checkoutBtn.disabled = !(customerName && deliveryAddress && cartCount > 0);
        }

        function checkout() {
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            
            if (!customerName || !deliveryAddress) {
                alert('Please fill in all required fields');
                return;
            }

            if (cartCount === 0) {
                alert('Your cart is empty');
                return;
            }

            // Prepare order data
            const orderData = {
                restaurantId: parseInt(restaurantId),
                customerName: customerName,
                deliveryAddress: deliveryAddress,
                totalAmount: cartTotal,
                items: Object.keys(cart).map(itemId => ({
                    menuItemId: parseInt(itemId),
                    menuItemName: cart[itemId].name,
                    quantity: cart[itemId].quantity,
                    price: cart[itemId].price
                }))
            };

            // Place order
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert(`Order placed successfully! Order ID: ${data.id}`);
                    // Clear cart
                    cart = {};
                    document.querySelectorAll('.quantity-display').forEach(span => span.textContent = '0');
                    updateCartDisplay();
                    toggleCart();
                } else {
                    alert('Error placing order. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error placing order. Please try again.');
            });
        }
    </script>
</body>
</html>
